<script>
  // Your published sheet base:
  const BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTPhJ75e207ll1_Tl6cyiX72A0dbepjDvC7ZUnI6gxS1ymrvG6vzjFxi03GeXgAop_gwPYgsg48-jRW";

  // Pull tabs as CSV
  const PLAYERS_CSV = `${BASE}/pub?output=csv&sheet=${encodeURIComponent("Players")}`;
  const KITS_CSV    = `${BASE}/pub?output=csv&sheet=${encodeURIComponent("Kits")}`;

  function parseCSV(csvText) {
    const rows = [];
    let row = [], cur = "", inQuotes = false;
    for (let i = 0; i < csvText.length; i++) {
      const ch = csvText[i];
      const next = csvText[i+1];
      if (ch === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
      if (ch === '"') { inQuotes = !inQuotes; continue; }
      if (ch === "," && !inQuotes) { row.push(cur); cur = ""; continue; }
      if ((ch === "\n" || ch === "\r") && !inQuotes) {
        if (cur.length || row.length) { row.push(cur); rows.push(row); }
        row = []; cur = "";
        continue;
      }
      cur += ch;
    }
    if (cur.length || row.length) { row.push(cur); rows.push(row); }
    return rows;
  }

  function pct(n) { return isFinite(n) ? `${Math.round(n * 1000) / 10}%` : ""; }

  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    })[c]);
  }

  // ---------------- Players ----------------
  let players = [];

  function renderPlayers() {
    const search = document.getElementById("search").value.trim().toLowerCase();
    const region = document.getElementById("region").value;
    const tier = document.getElementById("tier").value;
    const sort = document.getElementById("sort").value;

    let filtered = players.filter(p => {
      if (region && p.region !== region) return false;
      if (tier && p.tier !== tier) return false;
      if (search && !p.player.toLowerCase().includes(search)) return false;
      return true;
    });

    const sorters = {
      rating_desc: (a,b) => b.rating - a.rating,
      rating_asc:  (a,b) => a.rating - b.rating,
      wins_desc:   (a,b) => b.wins - a.wins,
      wr_desc:     (a,b) => (b.winRate - a.winRate),
      matches_desc:(a,b) => b.matches - a.matches,
    };
    filtered.sort(sorters[sort] || sorters.rating_desc);

    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";

    filtered.forEach((p, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td><strong>${escapeHtml(p.player)}</strong></td>
        <td><span class="pill">${escapeHtml(p.region || "")}</span></td>
        <td><span class="pill">${escapeHtml(p.tier || "")}</span></td>
        <td>${Math.round(p.rating)}</td>
        <td>${p.wins}</td>
        <td>${p.losses}</td>
        <td>${pct(p.winRate)}</td>
        <td>${p.matches}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("status").textContent =
      `Showing ${filtered.length} player(s). Refreshes every 30 seconds.`;
  }

  async function loadPlayers() {
    const res = await fetch(PLAYERS_CSV, { cache: "no-store" });
    if (!res.ok) throw new Error("Players CSV fetch failed");
    const csv = await res.text();
    const rows = parseCSV(csv);

    // Region, Players, StartRating, Rating, Wins, Losses, Matches, Tier
    const data = rows.slice(1).filter(r => r[1] && r[1].trim());

    players = data.map(r => {
      const region = (r[0] || "").trim();
      const player = (r[1] || "").trim();
      const rating = Number(r[3]) || 0;
      const wins = Number(r[4]) || 0;
      const losses = Number(r[5]) || 0;
      const matches = Number(r[6]) || (wins + losses);
      const tier = (r[7] || "").trim();
      const winRate = (wins + losses) > 0 ? wins / (wins + losses) : 0;
      return { region, player, rating, wins, losses, matches, tier, winRate };
    });

    renderPlayers();
  }

  // ---------------- Kits ----------------
  function renderKits(kits) {
    const el = document.getElementById("kits");
    if (!el) return;

    if (!kits.length) {
      el.innerHTML = `<div class="muted">No kits found. Add a sheet tab named <strong>Kits</strong> with columns: Mode, Kit, Notes.</div>`;
      return;
    }

    el.innerHTML = kits.map(k => `
      <div class="kit-card">
        <h3 class="kit-title">${escapeHtml(k.mode)}</h3>
        <pre class="kit-pre">${escapeHtml(k.kit)}</pre>
        ${k.notes ? `<div class="muted" style="margin-top:8px;">${escapeHtml(k.notes)}</div>` : ""}
      </div>
    `).join("");
  }

  async function loadKits() {
    const res = await fetch(KITS_CSV, { cache: "no-store" });
    if (!res.ok) throw new Error("Kits CSV fetch failed");
    const csv = await res.text();
    const rows = parseCSV(csv);

    // Mode, Kit, Notes
    const data = rows.slice(1).filter(r => (r[0] || "").trim());
    const kits = data.map(r => ({
      mode: (r[0] || "").trim(),
      kit: (r[1] || "").trim(),
      notes: (r[2] || "").trim(),
    }));

    renderKits(kits);
  }

  // ---------------- Controls + boot ----------------
  ["search","region","tier","sort"].forEach(id => {
    document.getElementById(id).addEventListener("input", renderPlayers);
    document.getElementById(id).addEventListener("change", renderPlayers);
  });

  loadPlayers().catch(err => {
    console.error(err);
    document.getElementById("status").textContent =
      "Could not load the Players tab. Make sure the sheet is published and the tab is named 'Players'.";
  });

  loadKits().catch(err => {
    console.error(err);
    const el = document.getElementById("kits");
    if (el) el.innerHTML = `<div class="muted">Could not load Kits. Make sure tab name is <strong>Kits</strong> and the sheet is published.</div>`;
  });

  setInterval(() => loadPlayers().catch(()=>{}), 30000);
  setInterval(() => loadKits().catch(()=>{}), 30000);
</script>
